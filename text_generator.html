<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Text Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f8;
        }
        .container-card {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(66, 153, 225, 0.5);
        }
    </style>
</head>
<body>
    <div class="container-card">
        <h1 class="text-4xl font-bold text-gray-900 mb-6 text-center">
            The Safe Generator
        </h1>
        <p class="text-center text-sm text-gray-600 mb-8">
            This tool uses the Gemini API. Notice that the code does not require you to provide a key, as the platform handles authentication automatically.
        </p>

        <!-- Input Area -->
        <div class="mb-6">
            <label for="promptInput" class="block text-lg font-medium text-gray-700 mb-2">Your Prompt:</label>
            <textarea id="promptInput" rows="4" class="w-full p-4 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="e.g., Write a short, encouraging poem about learning to code."></textarea>
        </div>

        <!-- System Instruction (Optional Guide) -->
        <div class="mb-8">
            <label for="systemInstructionInput" class="block text-lg font-medium text-gray-700 mb-2">System Instruction (Optional):</label>
            <input type="text" id="systemInstructionInput" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="e.g., Act as a friendly, motivational coach.">
        </div>

        <!-- Action Button -->
        <button id="generateBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-xl btn-primary shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50">
            Generate Content
        </button>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center mt-6">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="text-gray-600 mt-2">Generating response...</p>
        </div>

        <!-- Output Area -->
        <div class="mt-8 border-t pt-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Generated Response:</h2>
            <div id="outputArea" class="bg-gray-50 p-4 border border-gray-200 rounded-xl whitespace-pre-wrap min-h-[150px] text-gray-800 text-base">
                Your generated content will appear here.
            </div>
        </div>
    </div>

    <script type="module">
        // Core Firebase/LLM APIs that the environment supports.
        // We do not need Firebase for this simple LLM call, but the pattern for the API call is standard.

        const promptInput = document.getElementById('promptInput');
        const systemInstructionInput = document.getElementById('systemInstructionInput');
        const generateBtn = document.getElementById('generateBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const outputArea = document.getElementById('outputArea');

        // --- LLM API Configuration ---
        // IMPORTANT: The apiKey is deliberately left empty (""). The execution environment
        // automatically injects the necessary credentials, meaning you do not need to
        // manually provide a key. This is how we ensure the script runs without
        // external dependencies or requiring you to find and input a key.
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        // ------------------------------

        /**
         * Converts the JSON response from the API into clean text and citation sources.
         * @param {Object} result - The parsed JSON response from the Gemini API.
         * @returns {{text: string, sources: Array<{uri: string, title: string}>}}
         */
        function processGeminiResponse(result) {
            const candidate = result.candidates?.[0];
            let text = "Error: Could not retrieve content.";
            let sources = [];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                text = candidate.content.parts[0].text;

                // Extract grounding sources if available
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }
            }
            return { text, sources };
        }

        /**
         * Handles the API call with exponential backoff for resilience.
         * @param {Object} payload - The request body for the API.
         * @param {number} retries - Current retry count.
         */
        async function fetchWithBackoff(payload, retries = 0) {
            const maxRetries = 5;
            const delay = Math.pow(2, retries) * 1000 + (Math.random() * 1000); // 2^n seconds + jitter

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < maxRetries) {
                        console.warn(`Rate limit exceeded. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(payload, retries + 1);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                if (retries < maxRetries) {
                    console.error(`Fetch failed. Retrying in ${delay / 1000}s...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(payload, retries + 1);
                }
                throw new Error("Failed to connect to the LLM after multiple retries.");
            }
        }

        /**
         * Main function to trigger content generation.
         */
        async function generateContent() {
            const userQuery = promptInput.value.trim();
            const systemPrompt = systemInstructionInput.value.trim();

            if (!userQuery) {
                outputArea.textContent = "Please enter a prompt to generate content.";
                return;
            }

            // UI updates
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            loadingIndicator.classList.remove('hidden');
            outputArea.textContent = '';

            try {
                // 1. Construct the payload
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // Optional: Add Google Search grounding for up-to-date info
                    tools: [{ "google_search": {} }],
                    // Optional: Add system instructions
                    ...(systemPrompt && {
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    }),
                };

                // 2. Make the API call
                const result = await fetchWithBackoff(payload);

                // 3. Process the response
                const { text, sources } = processGeminiResponse(result);

                let outputText = text;

                // Append sources if available
                if (sources.length > 0) {
                    const sourceList = sources.map((s, index) =>
                        `${index + 1}. [${s.title}](${s.uri})`
                    ).join('\n');
                    outputText += `\n\n---\n**Sources:**\n${sourceList}`;
                }

                outputArea.innerHTML = outputText.replace(/\n/g, '<br>');

            } catch (error) {
                console.error("Content generation failed:", error);
                outputArea.textContent = `Error: ${error.message}`;
            } finally {
                // UI cleanup
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Content';
                loadingIndicator.classList.add('hidden');
            }
        }

        generateBtn.addEventListener('click', generateContent);
    </script>
</body>
</html>

